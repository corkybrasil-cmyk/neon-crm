<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neon Educacional ‚Äî CRM (Single HTML)</title>
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#0e1430; /* para degrad√™ opcional */
      --bg-soft:#121734;
      --card:#161d3b;
      --muted:#2a325e;
      --text:#eef3ff;
      --text-dim:#c8d0ff;
      --logo-neon:#c7f603; /* cor fixa da logomarca */
      --accent-neon:#c7f603; /* cor de destaque da UI (pode mudar) */
      --accent2:#9cff04; /* segunda cor do degrad√™ de destaque */
      --accent:#7ad7ff;
      --danger:#ff6b6b;
      --warning:#ffd166;
      --success:#06d6a0;
      --radius:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --nav-bg: linear-gradient(180deg,var(--bg-soft),#0f1540);
      --nav-text: var(--text);
      --nav-font: var(--font);
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:var(--font);} 
    body.bg-solid{ background: var(--bg); }
    header{display:flex;align-items:center;gap:16px;padding:14px 18px;border-bottom:1px solid var(--muted);position:sticky;top:0;background:rgba(11,16,32,.8);backdrop-filter: blur(8px);z-index:5}
    header .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:34px;display:grid;place-items:center}
    .app-title{font-weight:800;letter-spacing:.5px}
    .neon{color:var(--neon)}
    .layout{display:flex;min-height:calc(100vh - 70px)}
    nav{width:260px;padding:16px;border-right:1px solid var(--muted);background:var(--nav-bg);color:var(--nav-text);font-family:var(--nav-font);transition:width .2s ease}
    nav .tab{width:100%;text-align:left;padding:12px 14px;border:1px solid transparent;border-radius:12px;background:transparent;color:var(--nav-text);cursor:pointer;margin-bottom:8px;display:flex;align-items:center;gap:10px}
    nav .tab .icon{width:22px;display:inline-block;text-align:center}
    nav .tab .label{white-space:nowrap}
    nav .tab.active{background:var(--card);border-color:var(--muted)}
    nav .tab:hover{background:rgba(255,255,255,.04)}
    nav.collapsed{width:72px}
    nav.collapsed .tab{justify-content:center}
    nav.collapsed .tab .label{display:none}
    nav.collapsed:hover{width:260px}
    nav.collapsed:hover .tab{justify-content:flex-start}
    nav.collapsed:hover .tab .label{display:inline}
    main{flex:1;padding:20px}
    .grid{display:grid;gap:16px}
    .grid.kpi{grid-template-columns:repeat(4, minmax(0,1fr));}
    @media(max-width:1000px){.grid.kpi{grid-template-columns:repeat(2,1fr);}nav{width:220px}}
    @media(max-width:640px){.grid.kpi{grid-template-columns:1fr;}nav{display:none}}

    .card{background:var(--card);border:1px solid var(--muted);border-radius:var(--radius);padding:16px}
    .card h3{margin:0 0 8px 0;font-size:14px;color:var(--text-dim);font-weight:600}
    .value{font-size:32px;font-weight:900}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;background:#0f1533;border:1px solid var(--muted);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    button{background:#1b2350;border:1px solid var(--muted);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border:none;color:#0b1020;font-weight:800; background: var(--accent-neon)}
    body.accent-grad button.primary{ background: linear-gradient(90deg,var(--accent-neon), var(--accent2)); }
    button.ghost{background:transparent;border-color:var(--muted)}
    button.danger{background:var(--danger);border:none;color:#101010;font-weight:700}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--muted);font-size:12px;background:#0f1533}

    /* Kanban */
    .kanban{display:grid;grid-template-columns:repeat(5,minmax(280px,1fr));gap:20px;margin-top:16px}
    @media(max-width:1200px){.kanban{grid-template-columns:repeat(3,minmax(260px,1fr));}}
    @media(max-width:800px){.kanban{grid-template-columns:repeat(2,minmax(260px,1fr));}}
    @media(max-width:560px){.kanban{grid-template-columns:1fr}}
    .column{background:linear-gradient(180deg,#0f1533,#0e1430);border:1px solid var(--muted);border-radius:16px;padding:14px;min-height:160px;box-shadow:0 4px 10px rgba(0,0,0,.15)}
    .column header{position:unset;background:transparent;backdrop-filter:none;padding:0;border:none;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .column h4{margin:0;font-size:14px;color:var(--text-dim)}
    .draggable{background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:12px;margin-bottom:10px;cursor:grab}
    .draggable small{color:var(--text-dim)}
    #kanbanWrap{margin-top:12px}

    .pill{padding:.25rem .55rem;border-radius:999px;border:1px solid var(--muted);font-size:12px}
    .prio-baixa{background:#0a3a2c}
    .prio-m√©dia{background:#3a350a}
    .prio-alta{background:#3a120a}
    .prio-urgente{background:#3a0a2a}

    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .right{margin-left:auto}
    .muted{color:var(--text-dim)}
    .hidden{display:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);border:1px solid var(--muted);border-radius:16px;max-width:720px;width:min(92vw,720px);padding:16px}

    .tiny{font-size:11px;color:var(--text-dim)}
    .list{width:100%;border-collapse:collapse}
    .list th,.list td{border-bottom:1px solid var(--muted);padding:10px;text-align:left}
    .list th{color:var(--text-dim);font-weight:600}

    .dev-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.dev-grid{grid-template-columns:1fr}}

    .copy-input{width:100%;height:200px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-label="Neon logo">
        <!-- Inline SVG Logo -->
        <svg width="42" height="36" viewBox="0 0 431 368" xmlns="http://www.w3.org/2000/svg">
          <g mask="url(#m)">
            <mask id="m" maskUnits="userSpaceOnUse" x="0" y="0" width="431" height="368">
              <path d="M0.226562 0.716797H430.663V367.476H0.226562V0.716797Z" fill="#fff"/>
            </mask>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M255.207 109.518H229.474C226.689 109.518 224.419 107.247 224.608 104.49C228.068 49.238 288.346 19.4766 323.081 16.7735C325.838 16.5573 328.081 18.8008 328.081 21.5851V55.4282C328.081 58.2394 325.757 60.456 322.973 60.6992C293.212 63.2942 273.858 91.65 269.398 105.247C268.533 107.869 270.641 110.139 273.425 110.139H301.7C303.781 110.139 305.457 111.815 305.457 113.897V116.411C305.457 118.492 303.781 120.195 301.7 120.195H273.425C270.641 120.195 268.371 122.466 268.587 125.223C271.155 159.931 300.132 176.798 323.054 178.988C325.811 179.231 328.081 181.475 328.081 184.259V216.886C328.081 219.67 325.757 221.913 322.973 221.805C249.449 218.751 226.419 159.309 224.581 125.169C224.419 122.384 226.662 120.195 229.447 120.195H255.207C257.991 120.195 260.234 117.924 260.234 115.167V114.545C260.234 111.761 257.991 109.518 255.207 109.518ZM3.98382 7.15039H39.7994C41.8808 7.15039 43.5567 8.82633 43.5567 10.9077V18.6387C43.5567 21.4229 46.3409 22.9637 48.8007 21.6121C57.1531 17.0168 75.2366 9.01555 105.106 9.01555C163.438 9.01555 203.74 50.4274 205.551 104.49C205.606 106.571 203.903 108.247 201.821 108.247H166.681C164.6 108.247 162.897 106.571 162.735 104.49C160.681 78.9724 138.029 50.4814 105.106 50.4814C55.5043 50.4814 44.8542 90.9472 43.2053 105.139C42.962 107.22 41.2591 108.869 39.1777 108.869H4.63256C2.55119 108.869 0.848268 107.22 0.848268 105.139C0.821232 97.6509 0.74015 85.4869 0.604992 71.8361C0.442811 51.3464 0.253591 27.5049 0.226562 10.8807C0.226562 8.7993 1.90246 7.15039 3.98382 7.15039ZM263.397 264.65H227.581C225.5 264.65 223.824 266.299 223.824 268.38C223.851 285.004 224.04 308.846 224.203 329.336C224.311 342.986 224.419 355.15 224.446 362.638C224.446 364.719 226.122 366.395 228.203 366.395H262.748C264.83 366.395 266.533 364.719 266.776 362.638C268.452 348.447 279.102 307.981 328.703 307.981C361.599 307.981 384.251 336.499 386.333 361.989C386.495 364.071 388.171 365.747 390.252 365.747H425.419C427.5 365.747 429.203 364.071 429.122 361.989C427.338 307.927 387.008 266.515 328.703 266.515C298.807 266.515 280.724 274.516 272.398 279.112C269.938 280.49 267.154 278.922 267.154 276.138V268.407C267.154 266.326 265.478 264.65 263.397 264.65ZM5.25427 253.972H38.556C41.3402 253.972 43.5567 251.729 43.827 248.972C45.8003 228.455 59.4507 194.936 103.862 194.936C143.327 194.936 160.248 227.644 162.6 248.972C162.924 251.729 165.141 253.972 167.925 253.972H201.2C203.984 253.972 206.227 251.729 206.038 248.972C203.713 215.534 178.44 150.335 103.862 150.335C21.5808 150.335 2.14574 215.967 0.361716 248.972C0.226564 251.729 2.47011 253.972 5.25427 253.972ZM167.898 262.758H201.2C203.984 262.758 206.227 264.974 206.092 267.758C204.335 300.737 184.873 366.395 102.592 366.395C28.0141 366.395 2.74041 301.196 0.415777 267.758C0.226561 264.974 2.47011 262.758 5.25427 262.758H38.556C41.3132 262.758 43.5567 265.001 43.854 267.758C46.2057 289.086 63.1539 321.794 102.592 321.794C147.003 321.794 160.681 288.248 162.627 267.731C162.897 264.974 165.141 262.758 167.898 262.758Z" fill="var(--logo-neon)"/>
          </g>
        </svg>
      </div>
      <div class="app-title"><span class="neon">Neon</span> CRM</div>
    </div>
    <div class="right tiny">Dados salvos localmente ¬∑ Backup em "Salvar & Backup"</div>
  </header>

  <div class="layout">
    <nav class="collapsed">
      <button class="tab active" data-tab="dashboard"><span class="icon">üìä</span><span class="label">Dashboard</span></button>
      <button class="tab" data-tab="novoLead"><span class="icon">‚ûï</span><span class="label">Novo Lead</span></button>
      <button class="tab" data-tab="leads"><span class="icon">üß©</span><span class="label">Funil de Vendas</span></button>
      <button class="tab" data-tab="tarefas" id="tabTarefas"><span class="icon">üóÇÔ∏è</span><span class="label">Tarefas</span></button>
      <div id="submenuTarefas" class="hidden" style="margin:8px 0 0 0;display:flex;flex-direction:column;gap:6px">
        <button class="tab" data-tab="tarefas" data-tasktype="leads"><span class="icon">üéØ</span><span class="label">Com leads</span></button>
        <button class="tab" data-tab="tarefas" data-tasktype="escola"><span class="icon">üè´</span><span class="label">Com a escola</span></button>
      </div>
      <button class="tab" data-tab="pessoas"><span class="icon">üë•</span><span class="label">Pessoas & Empresas</span></button>
      <button class="tab" data-tab="dev"><span class="icon">üõ†Ô∏è</span><span class="label">Dev</span></button>
      <button class="tab" data-tab="backup"><span class="icon">üíæ</span><span class="label">Salvar & Backup</span></button>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <section id="dashboard" class="tabview">
        <div class="toolbar card">
          <div class="row" style="width:100%">
            <div>
              <label>Per√≠odo r√°pido</label>
              <select id="quickRange">
                <option value="last1">√öltimo dia</option>
                <option value="last7" selected>√öltima semana</option>
                <option value="last30">√öltimo m√™s</option>
                <option value="custom">Personalizado‚Ä¶</option>
              </select>
            </div>
            <div id="customDates" class="row" style="display:none">
              <div>
                <label>De</label>
                <input type="date" id="fromDate" />
              </div>
              <div>
                <label>At√©</label>
                <input type="date" id="toDate" />
              </div>
              <div style="align-self:flex-end">
                <button id="applyDates" class="primary">Aplicar</button>
              </div>
            </div>
          </div>
        </div>
        <div class="grid kpi">
          <div class="card"><h3>Leads que entraram</h3><div class="value" id="kpiEntraram">0</div><div class="tiny" id="kpiEntraramHint">no per√≠odo</div></div>
          <div class="card"><h3>Leads qualificados</h3><div class="value" id="kpiQualificados">0</div><div class="tiny">status alterado para "qualificado" no per√≠odo</div></div>
          <div class="card"><h3>Vendas</h3><div class="value" id="kpiVendas">0</div><div class="tiny">convers√µes para "venda" no per√≠odo</div></div>
          <div class="card"><h3>Ticket m√©dio</h3><div class="value" id="kpiTicket">R$ 0,00</div><div class="tiny">m√©dia das vendas do per√≠odo</div></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Leads por bairro</h3>
          <table class="list" style="margin-top:8px">
            <thead><tr><th>Bairro</th><th>Quantidade</th></tr></thead>
            <tbody id="bairroTable"></tbody>
          </table>
        </div>
      </section>

      <!-- NOVO LEAD -->
      <section id="novoLead" class="tabview hidden">
        <div class="card">
          <h3>Novo Lead</h3>
          <div class="row">
            <div><label>Nome do respons√°vel</label><input id="leadResp" placeholder="Ex: Ana Souza"/></div>
            <div><label>Telefone</label><input id="leadTel" placeholder="(xx) xxxxx-xxxx"/></div>
            <div><label>Bairro</label><input id="leadBairro" placeholder="Ex: Centro"/></div>
          </div>
          <div class="row">
            <div><label>Nome da crian√ßa</label><input id="leadCrianca" placeholder="Ex: Pedro"/></div>
            <div><label>Idade da crian√ßa</label><input id="leadIdade" type="number" min="0" max="12"/></div>
            <div>
              <label>Per√≠odo de interesse</label>
              <select id="leadPeriodo"><option>manh√£</option><option>tarde</option></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Frequ√™ncia (vezes/semana)</label>
              <select id="leadFrequencia"><option>3</option><option>4</option><option>5</option></select>
            </div>
            <div>
              <label>Fonte do lead</label>
              <select id="leadFonte"><option>marketing digital</option><option>indica√ß√£o</option><option>outros</option></select>
            </div>
            <div>
              <label>Etapa</label>
              <select id="leadEtapa"></select>
            </div>
          </div>
          <div class="row">
            <div><label>Valor da venda (opcional, para ticket m√©dio)</label><input id="leadValor" type="number" min="0" step="0.01" placeholder="Ex: 799.90"/></div>
            <div><label>Observa√ß√µes</label><textarea id="leadObs" placeholder="Observa√ß√µes sobre o lead"></textarea></div>
          </div>
          <div class="row">
            <div class="right"><button id="btnAddLead" class="primary">Adicionar Lead</button></div>
          </div>
        </div>
      </section>

      <!-- FUNIL DE VENDAS -->
      <section id="leads" class="tabview hidden">
        <div class="toolbar card">
          <div class="row" style="width:100%">
            <div>
              <label>Visualiza√ß√£o</label>
              <select id="leadView">
                <option value="kanban" selected>Kanban</option>
                <option value="lista">Lista</option>
              </select>
            </div>
            <div class="right" style="align-self:flex-end;display:flex;gap:8px">
              <button id="editStages" class="ghost">Editar etapas</button>
              <button id="addStage" class="ghost hidden">+ Etapa</button>
              <button id="saveStages" class="primary hidden">Salvar etapas</button>
            </div>
          </div>
        </div>
        <div id="kanbanWrap" class="kanban" style="margin-top:12px"></div>
        <div id="listWrap" class="hidden">
          <div class="row" style="margin-bottom:8px">
            <div><label>Buscar</label><input id="leadSearch" placeholder="Digite para filtrar"/></div>
            <div><label>Colunas vis√≠veis</label><div id="leadCols" class="row" style="gap:8px"></div></div>
          </div>
          <table class="list" id="leadTable">
            <thead>
              <tr id="leadHead"></tr>
            </thead>
            <tbody id="leadListBody"></tbody>
          </table>
        </div>
      </section>

      <!-- TAREFAS -->
      <section id="tarefas" class="tabview hidden">
        <div class="toolbar card">
          <div class="row" style="width:100%">
            <div>
              <label>Tipo de tarefas</label>
              <select id="taskType">
                <option value="leads">Tarefas com leads</option>
                <option value="escola">Tarefas com a escola</option>
              </select>
            </div>
            <div class="right" style="align-self:flex-end;display:flex;gap:8px">
              <button id="btnTaskNew" class="primary">Nova tarefa</button>
              <button id="btnTaskStages" class="ghost">Personalizar etapas</button>
            </div>
          </div>
        </div>
        <div id="taskKanban" class="kanban"></div>
      </section>

      <!-- PESSOAS & EMPRESAS -->
      <section id="pessoas" class="tabview hidden">
        <div class="toolbar card">
          <div class="row" style="width:100%">
            <div>
              <label>Filtrar por tipo</label>
              <select id="entFilterType">
                <option value="todos">Todos</option>
                <option value="pessoa">Pessoa f√≠sica</option>
                <option value="empresa">Pessoa jur√≠dica</option>
              </select>
            </div>
            <div>
              <label>Filtrar por finalidade</label>
              <input id="entFilterFinalidade" placeholder="Ex: fornecedor, conv√™nio, influenciador"/>
            </div>
            <div class="right" style="align-self:flex-end"><button id="btnNewEnt" class="primary">Adicionar</button></div>
          </div>
        </div>
        <table class="list">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Telefone</th><th>Finalidade</th><th>Contato (empresa)</th></tr></thead>
          <tbody id="entList"></tbody>
        </table>
      </section>

      <!-- DEV -->
      <section id="dev" class="tabview hidden">
        <div class="dev-grid">
          <div class="card">
            <h3>Tema & Layout</h3>
            <div class="row">
              <div><label>Cor de destaque</label><input id="setNeon" type="color" value="#c7f603"></div>
              <div><label>Cor de destaque (2)</label><input id="setNeon2" type="color" value="#9cff04"></div>
              <div style="flex:0 0 220px"><label>Usar degrad√™ destaque?</label><input id="setNeonGrad" type="checkbox" checked></div>
            </div>
            <div class="row">
              <div><label>Fundo</label><input id="setBg" type="color" value="#0b1020"></div>
              <div><label>Fundo (2)</label><input id="setBg2" type="color" value="#0e1430"></div>
              <div style="flex:0 0 220px"><label>Usar degrad√™ fundo?</label><input id="setBgGrad" type="checkbox" checked></div>
            </div>
            <div class="row">
              <div><label>Fonte geral</label><input id="setFont" placeholder="Ex: Inter, Poppins"/></div>
            </div>
            <div class="row">
              <button id="applyTheme" class="primary">Aplicar</button>
              <button id="resetTheme" class="ghost">Restaurar</button>
            </div>
            <div class="tiny">Dica: todas as cores ficam em vari√°veis CSS no <code>:root</code>.</div>
          </div>
          <div class="card">
            <h3>Adicionar nova aba</h3>
            <div class="row">
              <button id="genTabPrompt" class="ghost">Gerar prompt para LLM</button>
              <button id="addBlankTab" class="primary">+ Nova aba vazia</button>
            </div>
            <textarea id="tabPrompt" class="copy-input" placeholder="Clique em 'Gerar prompt para LLM' para preencher automaticamente."></textarea>
            <div class="row">
              <button id="copyTabPrompt">Copiar prompt</button>
            </div>
          </div>
          <div class="card">
            <h3>Adicionar nova funcionalidade</h3>
            <div class="row"><button id="genFeatPrompt" class="ghost">Gerar prompt para LLM</button></div>
            <textarea id="featPrompt" class="copy-input" placeholder="Clique em 'Gerar prompt para LLM' para preencher automaticamente."></textarea>
            <div class="row"><button id="copyFeatPrompt">Copiar prompt</button></div>
          </div>
          <div class="card">
            <h3>Menu</h3>
            <div class="row">
              <div><label>Fundo do menu (CSS)</label><input id="setNavBg" placeholder="Ex: linear-gradient(180deg,#121734,#0f1540)"/></div>
              <div><label>Cor do texto do menu</label><input id="setNavText" type="color" value="#eef3ff"/></div>
              <div><label>Fonte do menu</label><input id="setNavFont" placeholder="Ex: Poppins, Inter"/></div>
              <div>
                <label>Posi√ß√£o do menu</label>
                <select id="setNavPos">
                  <option value="left" selected>Lateral esquerda</option>
                  <option value="top">Topo (cabe√ßalho)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="backup" class="tabview hidden">
        <div class="card">
          <h3>Salvar & Backup</h3>
          <div class="row">
            <div>
              <button id="btnExport" class="primary">Exportar dados (.json)</button>
            </div>
            <div>
              <label>Importar .json</label>
              <input type="file" id="fileImport" accept="application/json"/>
              <button id="btnImport" class="primary" style="margin-top:8px;">Importar arquivo</button>
            </div>
          </div>
          <div class="tiny">Itens exportados: leads, tarefas, pessoas/empresas, etapas e tema.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="flex-between" style="margin-bottom:8px"><strong id="modalTitle">T√≠tulo</strong><button id="modalClose" class="ghost">‚úï</button></div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    /* ==========================
       Estado & Persist√™ncia
    ========================== */
    const Store = {
      key: 'neon-crm-v1',
      data: {
        stages: ["novo lead","qualificado","proposta","venda","perdido"],
        leads: [],
        tasks: {
          leads: { stages:["para fazer","fazendo"], items:[] },
          escola:{ stages:["para fazer","fazendo"], items:[] }
        },
        entities: [],
        theme: {}
      },
      load(){
        try{ const raw = localStorage.getItem(this.key); if(raw){ this.data = JSON.parse(raw); } }catch(e){ console.warn('Falha ao carregar', e) }
      },
      save(){ localStorage.setItem(this.key, JSON.stringify(this.data)); }
    };
    Store.load();

    /* ==========================
       Utilidades
    ========================== */
    const $$ = sel => document.querySelector(sel);
    const $$$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtBRL = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const uid = () => Math.random().toString(36).slice(2,9);
    const todayISO = () => new Date().toISOString();
    const toDateOnly = (d) => new Date(new Date(d).toDateString());
    const inRange = (d, a, b) => { const x=toDateOnly(d).getTime(); return x>=toDateOnly(a).getTime() && x<=toDateOnly(b).getTime(); };

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position='fixed';t.style.bottom='16px';t.style.right='16px';t.style.padding='10px 14px';t.style.background='var(--card)';t.style.border='1px solid var(--muted)';t.style.borderRadius='12px';t.style.zIndex='100';
      document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
    }

    /* ==========================
       Navega√ß√£o entre abas
    ========================== */
    $$$('nav .tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$$('nav .tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.tab;
        $$$('.tabview').forEach(s=>s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id==='leads') renderLeads();
        if(id==='tarefas') renderTasks();
        if(id==='pessoas') renderEntities();
        if(id==='dashboard') calcKPIs();
      })
    })

    // Submenu Tarefas colaps√°vel
    const tabTarefas = document.getElementById('tabTarefas');
    const submenuTarefas = document.getElementById('submenuTarefas');
    if(tabTarefas){
      tabTarefas.addEventListener('click',(e)=>{
        e.stopPropagation();
        submenuTarefas.classList.toggle('hidden');
      });
      submenuTarefas.addEventListener('click',(e)=>{
        const btn = e.target.closest('button[data-tasktype]');
        if(!btn) return;
        const v = btn.dataset.tasktype; $$('#taskType').value = v; renderTasks();
        $$$('nav .tab').forEach(b=>b.classList.remove('active'));
        tabTarefas.classList.add('active');
        $$$('.tabview').forEach(s=>s.classList.add('hidden'));
        document.getElementById('tarefas').classList.remove('hidden');
      });
    }

    /* ==========================
       Dashboard & Filtros de Data
    ========================== */
    const quickRange = $$('#quickRange');
    const customDates = $$('#customDates');
    const fromDate = $$('#fromDate');
    const toDate = $$('#toDate');
    const applyDates = $$('#applyDates');

    function getRange(){
      const now = new Date();
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      let start = new Date(end);
      const v = quickRange.value;
      if(v==='last1') start.setDate(end.getDate()-1);
      if(v==='last7') start.setDate(end.getDate()-6);
      if(v==='last30') start.setDate(end.getDate()-29);
      if(v==='custom'){
        const a = fromDate.value ? new Date(fromDate.value) : end;
        const b = toDate.value ? new Date(toDate.value) : end;
        return {start:a, end:b};
      }
      return {start, end};
    }

    quickRange.addEventListener('change',()=>{
      customDates.style.display = quickRange.value==='custom' ? 'flex' : 'none';
      calcKPIs();
    });
    applyDates.addEventListener('click', calcKPIs);

    function calcKPIs(){
      const {start,end} = getRange();
      const leads = Store.data.leads;
      const entrou = leads.filter(l=> inRange(l.createdAt,start,end)).length;
      const qualificados = leads.filter(l=> l.etapa==='qualificado' && inRange(l.stageChangedAt||l.updatedAt||l.createdAt,start,end)).length;
      const vendas = leads.filter(l=> l.etapa==='venda' && inRange(l.stageChangedAt||l.updatedAt||l.createdAt,start,end));
      const ticket = vendas.length ? vendas.reduce((s,l)=>s+(Number(l.valorVenda)||0),0)/vendas.length : 0;
      $$('#kpiEntraram').textContent = entrou;
      $$('#kpiQualificados').textContent = qualificados;
      $$('#kpiVendas').textContent = vendas.length;
      $$('#kpiTicket').textContent = fmtBRL(ticket);
      $$('#kpiEntraramHint').textContent = `de ${start.toLocaleDateString()} a ${end.toLocaleDateString()}`;

      // Tabela por bairro
      const counts = {};
      leads.forEach(l=>{ const b=(l.bairro||'‚Äî').trim(); counts[b]=(counts[b]||0)+1; });
      const tbody = $$('#bairroTable'); if(tbody){
        const rows = Object.entries(counts).sort((a,b)=> b[1]-a[1]).map(([b,q])=>`<tr><td>${b}</td><td>${q}</td></tr>`).join('');
        tbody.innerHTML = rows;
      }
    }

    /* ==========================
       Novo Lead
    ========================== */
    function refreshEtapasOptions(){
      const sel = $$('#leadEtapa'); sel.innerHTML = '';
      Store.data.stages.forEach(s=>{ const o=document.createElement('option'); o.textContent=s; sel.appendChild(o); });
    }
    refreshEtapasOptions();

    $$('#btnAddLead').addEventListener('click',()=>{
      const lead = {
        id: uid(),
        responsavel: $$('#leadResp').value.trim(),
        crianca: $$('#leadCrianca').value.trim(),
        idade: Number($$('#leadIdade').value||0),
        periodo: $$('#leadPeriodo').value,
        frequencia: $$('#leadFrequencia').value,
        fonte: $$('#leadFonte').value,
        telefone: $$('#leadTel').value.trim(),
        bairro: $$('#leadBairro').value.trim(),
        etapa: $$('#leadEtapa').value,
        valorVenda: Number($$('#leadValor').value||0),
        observacoes: ($$('#leadObs')?.value||'').trim(),
        createdAt: todayISO(),
        updatedAt: todayISO(),
        stageChangedAt: todayISO(),
      };
      if(!lead.responsavel || !lead.crianca){ toast('Preencha respons√°vel e crian√ßa'); return; }
      Store.data.leads.push(lead); Store.save();
      $$$('#novoLead input').forEach(i=>i.value='');
      $$$('#novoLead textarea').forEach(i=>i.value='');
      refreshEtapasOptions();
      toast('Lead adicionado!');
      renderLeads(); calcKPIs();
    });

    /* ==========================
       Leads: Kanban & Lista
    ========================== */
    const leadViewSel = $$('#leadView');
    leadViewSel.addEventListener('change',()=>{
      const isKanban = leadViewSel.value==='kanban';
      $$('#kanbanWrap').classList.toggle('hidden',!isKanban);
      $$('#listWrap').classList.toggle('hidden',isKanban);
      renderLeads();
    });

    $$('#editStages').addEventListener('click',()=>{
      document.body.dataset.editStages = document.body.dataset.editStages? '' : '1';
      const on = !!document.body.dataset.editStages;
      $$('#addStage').classList.toggle('hidden',!on);
      $$('#saveStages').classList.toggle('hidden',!on);
      $$('#editStages').textContent = on? 'Cancel. edi√ß√£o' : 'Editar etapas';
      renderLeads();
    });
    $$('#addStage').addEventListener('click',()=>{
      const name = prompt('Nome da nova etapa:');
      if(!name) return; Store.data.stages.push(name); renderLeads();
    });
    $$('#saveStages').addEventListener('click',()=>{
      document.body.dataset.editStages='';
      $$('#addStage').classList.add('hidden');
      $$('#saveStages').classList.add('hidden');
      $$('#editStages').textContent='Editar etapas';
      Store.save(); renderLeads(); refreshEtapasOptions();
      toast('Etapas salvas');
    });

    function renderLeads(){
      const wrap = $$('#kanbanWrap'); wrap.innerHTML='';
      const isKanban = leadViewSel.value==='kanban';
      if(!isKanban){
        renderLeadTable();
        return;
      }
      // Kanban columns
      Store.data.stages.forEach((stage, idx)=>{
        const col = document.createElement('div'); col.className='column'; col.dataset.stage=stage;
        const head = document.createElement('header');
        const h4 = document.createElement('h4'); h4.textContent=stage; h4.contentEditable = !!document.body.dataset.editStages;
        h4.addEventListener('input',()=>{ Store.data.stages[idx]=h4.textContent.trim()||stage; });
        const tools = document.createElement('div');
        if(document.body.dataset.editStages){
          const del = document.createElement('button'); del.textContent='üóëÔ∏è'; del.className='ghost';
          del.addEventListener('click',()=>{
            if(!confirm('Remover etapa? Leads migrar√£o para a etapa anterior.')) return;
            const prev = Store.data.stages[idx-1] || Store.data.stages[0];
            Store.data.leads.forEach(l=>{ if(l.etapa===stage) l.etapa=prev; });
            Store.data.stages.splice(idx,1); renderLeads(); refreshEtapasOptions();
          });
          tools.appendChild(del);
        }
        head.append(h4, tools); col.appendChild(head);

        col.addEventListener('dragover',e=>{ e.preventDefault(); });
        col.addEventListener('drop',e=>{
          const id = e.dataTransfer.getData('text/plain');
          const lead = Store.data.leads.find(x=>x.id===id);
          if(lead){ lead.etapa = stage; lead.stageChangedAt=todayISO(); lead.updatedAt=todayISO(); Store.save(); renderLeads(); calcKPIs(); }
        });

        wrap.appendChild(col);
      });

      // Cards
      Store.data.leads.forEach(l=>{
        const col = wrap.querySelector(`.column[data-stage="${CSS.escape(l.etapa)}"]`) || wrap.querySelector('.column');
        const card = document.createElement('div'); card.className='draggable'; card.draggable=true; card.id=l.id; card.tabIndex=0;
        card.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain',l.id); });
        card.innerHTML = `
          <strong>${l.crianca}</strong> <span class="tiny">(${l.idade} anos)</span>
          <div class="tiny">Resp.: ${l.responsavel} ‚Äî ${l.telefone}</div>
          <div class="tiny">${l.periodo} ¬∑ ${l.frequencia}x/sem ¬∑ ${l.fonte}</div>
          <div class="tiny">Bairro: ${l.bairro} ${l.valorVenda? '¬∑ Valor: '+fmtBRL(l.valorVenda):''}</div>
        `;
        card.onclick = ()=> openLeadViewModal(l);
        card.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openLeadViewModal(l); } };
        col.appendChild(card);
      });
    }

    function openLeadViewModal(l){
      const tasksForLead = Store.data.tasks.leads.items.filter(t=>t.leadId===l.id);
      openModal('Lead', `
        <div class='row'>
          <div><label>Respons√°vel</label><input id='vResp' value='${l.responsavel}' disabled/></div>
          <div><label>Telefone</label><input id='vTel' value='${l.telefone}' disabled/></div>
          <div><label>Bairro</label><input id='vBairro' value='${l.bairro}' disabled/></div>
        </div>
        <div class='row'>
          <div><label>Crian√ßa</label><input id='vCrianca' value='${l.crianca}' disabled/></div>
          <div><label>Idade</label><input id='vIdade' type='number' value='${l.idade}' disabled/></div>
          <div><label>Per√≠odo</label><input id='vPeriodo' value='${l.periodo}' disabled/></div>
        </div>
        <div class='row'>
          <div><label>Frequ√™ncia</label><input id='vFreq' value='${l.frequencia}' disabled/></div>
          <div><label>Fonte</label><input id='vFonte' value='${l.fonte}' disabled/></div>
          <div><label>Etapa</label><input id='vEtapa' value='${l.etapa}' disabled/></div>
        </div>
        <div class='row'>
          <div><label>Valor da venda</label><input id='vValor' type='number' step='0.01' value='${l.valorVenda||''}' disabled/></div>
          <div><label>Observa√ß√µes</label><textarea id='vObs' disabled>${l.observacoes||''}</textarea></div>
        </div>
        <div class='card' style='margin:8px 0'>
          <h3>Intera√ß√µes</h3>
          <div class='tiny'>Criado em ${new Date(l.createdAt).toLocaleString()} ‚Äî Atualizado em ${new Date(l.updatedAt).toLocaleString()}</div>
          ${l.stageChangedAt? `<div class='tiny'>√öltima mudan√ßa de etapa: ${new Date(l.stageChangedAt).toLocaleString()}</div>`:''}
        </div>
        <div class='card'>
          <h3>Tarefas deste lead</h3>
          <div id='leadTasksBox'>${tasksForLead.map(t=>`<div class='tiny'>${new Date(t.prazo).toLocaleDateString()} ‚Äî ${t.descricao} <span class='pill prio-${t.prioridade}'>${t.prioridade}</span> ¬∑ ${t.etapa}</div>`).join('') || '<div class="tiny">Nenhuma tarefa agendada.</div>'}</div>
          <div class='row' style='margin-top:6px'><button id='showDoneTasks' class='ghost'>Mostrar conclu√≠das</button></div>
        </div>
        <div class='row'><div class='right'><button id='vEdit' class='primary'>Editar</button></div></div>
      `);
      $$('#showDoneTasks').onclick = ()=>{
        // conclu√≠das = itens cujo etapa n√£o exista mais ou etapa 'feito' (se usu√°rio criar); como n√£o h√° status done nativo, apenas demonstra√ß√£o:
        toast('No momento, conclu√≠das dependem de uma etapa criada pelo usu√°rio (ex: "conclu√≠da").');
      };
      $$('#vEdit').onclick = ()=>{
        closeModal(); openLeadModal(l);
        // adiciona bot√£o excluir na modal de edi√ß√£o
        const box = document.getElementById('modalBody');
        const row = document.createElement('div'); row.className='row'; row.innerHTML = `<button id='mDel' class='danger'>Excluir</button>`; box.appendChild(row);
        document.getElementById('mDel').onclick = ()=>{ if(confirm('Excluir lead?')){ Store.data.leads = Store.data.leads.filter(x=>x.id!==l.id); Store.save(); closeModal(); renderLeads(); calcKPIs(); } };
      };
    }

    // Tabela de leads (lista) com filtros, ordena√ß√£o e colunas din√¢micas
    const defaultCols = [
      {key:'responsavel', label:'Respons√°vel', required:true},
      {key:'crianca', label:'Crian√ßa', required:true},
      {key:'idade', label:'Idade'},
      {key:'periodo', label:'Per√≠odo'},
      {key:'frequencia', label:'Freq.'},
      {key:'fonte', label:'Fonte'},
      {key:'telefone', label:'Telefone', required:true},
      {key:'bairro', label:'Bairro'},
      {key:'etapa', label:'Etapa'},
      {key:'valorVenda', label:'Valor'}
    ];
    let leadColsState = null;
    let leadSort = {key:'responsavel', dir:1};

    function renderLeadTable(){
      if(!leadColsState){ leadColsState = defaultCols.map(c=>({ ...c, visible: c.required || true })); }
      const head = $$('#leadHead'); const tbody = $$('#leadListBody'); const colsBox = $$('#leadCols');
      // Caixa de colunas
      colsBox.innerHTML = '';
      leadColsState.forEach((c,i)=>{
        const wrap = document.createElement('label'); wrap.className='tag'; wrap.draggable=true; wrap.dataset.idx=i;
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!c.visible; cb.disabled = !!c.required; cb.onchange = ()=>{ c.visible = cb.checked; renderLeadTable(); };
        wrap.appendChild(cb); wrap.appendChild(document.createTextNode(' '+c.label)); colsBox.appendChild(wrap);
        wrap.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain', i); });
        wrap.addEventListener('dragover',e=>{ e.preventDefault(); });
        wrap.addEventListener('drop',e=>{ e.preventDefault(); const from=+e.dataTransfer.getData('text/plain'); const to=i; const item=leadColsState.splice(from,1)[0]; leadColsState.splice(to,0,item); renderLeadTable(); });
      });
      // Header clic√°vel para ordenar
      head.innerHTML = '';
      leadColsState.forEach(c=>{
        if(!c.visible) return; const th=document.createElement('th'); th.textContent=c.label; th.style.cursor='pointer';
        th.onclick = ()=>{ leadSort.key=c.key; leadSort.dir*=-1; renderLeadTable(); };
        head.appendChild(th);
      });
      // Dados filtrados/ordenados
      const q = ($$('#leadSearch')?.value||'').toLowerCase();
      const data = Store.data.leads
        .filter(l=> JSON.stringify(l).toLowerCase().includes(q))
        .sort((a,b)=>{ const va=a[leadSort.key]; const vb=b[leadSort.key]; return (va>vb?1:va<vb?-1:0)*leadSort.dir; });
      tbody.innerHTML='';
      data.forEach(l=>{
        const tr=document.createElement('tr'); tr.tabIndex=0; tr.onclick=()=> openLeadViewModal(l); tr.onkeydown=(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openLeadViewModal(l);} };
        leadColsState.forEach(c=>{
          if(!c.visible) return; let v=l[c.key]; if(c.key==='valorVenda') v = v? fmtBRL(v):'-';
          const td=document.createElement('td'); td.textContent = (v??'').toString(); tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function openLeadModal(l){
      openModal('Editar Lead', `
        <div class='row'>
          <div><label>Respons√°vel</label><input id='mResp' value='${l.responsavel}'/></div>
          <div><label>Telefone</label><input id='mTel' value='${l.telefone}'/></div>
          <div><label>Bairro</label><input id='mBairro' value='${l.bairro}'/></div>
        </div>
        <div class='row'>
          <div><label>Crian√ßa</label><input id='mCrianca' value='${l.crianca}'/></div>
          <div><label>Idade</label><input id='mIdade' type='number' value='${l.idade}'/></div>
          <div><label>Per√≠odo</label><select id='mPeriodo'><option ${l.periodo==='manh√£'?'selected':''}>manh√£</option><option ${l.periodo==='tarde'?'selected':''}>tarde</option></select></div>
        </div>
        <div class='row'>
          <div><label>Frequ√™ncia</label><select id='mFreq'><option ${l.frequencia==='3'?'selected':''}>3</option><option ${l.frequencia==='4'?'selected':''}>4</option><option ${l.frequencia==='5'?'selected':''}>5</option></select></div>
          <div><label>Fonte</label><select id='mFonte'><option ${l.fonte==='marketing digital'?'selected':''}>marketing digital</option><option ${l.fonte==='indica√ß√£o'?'selected':''}>indica√ß√£o</option><option ${l.fonte==='outros'?'selected':''}>outros</option></select></div>
          <div><label>Etapa</label><select id='mEtapa'>${Store.data.stages.map(s=>`<option ${l.etapa===s?'selected':''}>${s}</option>`).join('')}</select></div>
        </div>
        <div class='row'>
          <div><label>Valor da venda</label><input id='mValor' type='number' step='0.01' value='${l.valorVenda||''}'/></div>
        </div>
        <div class='row'><div class='right'><button id='mSalvar' class='primary'>Salvar</button></div></div>
      `);
      $$('#mSalvar').onclick = ()=>{
        l.responsavel = $$('#mResp').value.trim();
        l.telefone = $$('#mTel').value.trim();
        l.bairro = $$('#mBairro').value.trim();
        l.crianca = $$('#mCrianca').value.trim();
        l.idade = Number($$('#mIdade').value||0);
        l.periodo = $$('#mPeriodo').value;
        l.frequencia = $$('#mFreq').value;
        l.fonte = $$('#mFonte').value;
        const newStage = $$('#mEtapa').value;
        if(newStage!==l.etapa){ l.etapa=newStage; l.stageChangedAt=todayISO(); }
        l.valorVenda = Number($$('#mValor').value||0);
        l.updatedAt = todayISO();
        Store.save(); closeModal(); renderLeads(); calcKPIs();
      }
    }

    function quickMoveLead(l){
      const idx = Store.data.stages.indexOf(l.etapa);
      const next = Store.data.stages[idx+1] || Store.data.stages[0];
      if(confirm(`Mover "${l.crianca}" de ${l.etapa} para ${next}?`)){
        l.etapa=next; l.stageChangedAt=todayISO(); l.updatedAt=todayISO(); Store.save(); renderLeads(); calcKPIs();
      }
    }

    /* ==========================
       Tarefas (Leads / Escola)
    ========================== */
    const taskTypeSel = $$('#taskType');
    taskTypeSel.addEventListener('change', renderTasks);
    $$('#btnTaskStages').addEventListener('click',()=> customizeTaskStages(taskTypeSel.value));
    $$('#btnTaskNew').addEventListener('click',()=> newTask(taskTypeSel.value));

    function renderTasks(){
      const type = taskTypeSel.value; const area = $$('#taskKanban'); area.innerHTML='';
      const cfg = Store.data.tasks[type];
      cfg.stages.forEach(stage=>{
        const col = document.createElement('div'); col.className='column'; col.dataset.stage=stage;
        const head = document.createElement('header');
        const h4 = document.createElement('h4'); h4.textContent = stage; h4.contentEditable = !!document.body.dataset.editTaskStages;
        h4.addEventListener('input',()=>{ const i=cfg.stages.indexOf(stage); if(i>-1) cfg.stages[i]=h4.textContent.trim()||stage; });
        const tools = document.createElement('div');
        if(document.body.dataset.editTaskStages){
          if(stage!=='para fazer' && stage!=='fazendo'){
            const del = document.createElement('button'); del.textContent='-'; del.className='ghost';
            del.onclick = ()=>{ if(!confirm('Remover etapa? Itens ir√£o para etapa anterior.')) return; const idx=cfg.stages.indexOf(stage); const prev=cfg.stages[idx-1]||cfg.stages[0]; cfg.items.forEach(t=>{ if(t.etapa===stage) t.etapa=prev; }); cfg.stages.splice(idx,1); renderTasks(); };
            tools.appendChild(del);
          }
          const add = document.createElement('button'); add.textContent='+'; add.className='ghost'; add.onclick = ()=>{ const name=prompt('Nome da etapa'); if(!name) return; cfg.stages.push(name); renderTasks(); };
          tools.appendChild(add);
        }
        head.append(h4,tools); col.appendChild(head);
        col.addEventListener('dragover',e=>e.preventDefault());
        col.addEventListener('drop',e=>{ const id=e.dataTransfer.getData('text/plain'); const item=cfg.items.find(t=>t.id===id); if(item){ item.etapa=stage; Store.save(); renderTasks(); }});
        area.appendChild(col);
      });
      cfg.items.forEach(t=>{
        const col = area.querySelector(`.column[data-stage="${CSS.escape(t.etapa)}"]`) || area.querySelector('.column');
        const d = document.createElement('div'); d.className='draggable'; d.draggable=true; d.id=t.id;
        d.addEventListener('dragstart',e=> e.dataTransfer.setData('text/plain', t.id));
        const pr = t.prioridade||'baixa';
        const tag = `<span class='pill prio-${pr}'>${pr}</span>`;
        const link = (taskTypeSel.value==='leads' ? (Store.data.leads.find(l=>l.id===t.leadId)?.crianca||'-') : (Store.data.entities.find(e=>e.id===t.entityId)?.nome||'-'));
        d.innerHTML = `
          <div class='flex-between'><strong>${t.descricao}</strong> ${tag}</div>
          <div class='tiny'>V√≠nculo: ${link}</div>
          <div class='tiny'>Prazo: ${new Date(t.prazo).toLocaleDateString()}</div>
          <div class='row' style='margin-top:6px'>
            <button class='ghost' data-act='edit'>Editar</button>
            <button class='danger' data-act='del'>Excluir</button>
          </div>`;
        d.querySelector('[data-act="edit"]').onclick = ()=> openTaskModal(type, t);
        d.querySelector('[data-act="del"]').onclick = ()=>{ if(confirm('Excluir tarefa?')){ cfg.items = cfg.items.filter(x=>x.id!==t.id); Store.save(); renderTasks(); } };
        col.appendChild(d);
      })
    }

    function customizeTaskStages(type){
      document.body.dataset.editTaskStages = document.body.dataset.editTaskStages? '' : '1';
      renderTasks();
      if(!document.body.dataset.editTaskStages){ Store.save(); toast('Etapas atualizadas'); }
    }

    function newTask(type){
      openTaskModal(type, null);
    }

    function openTaskModal(type, t){
      const cfg = Store.data.tasks[type];
      const isLead = type==='leads';
      const stagesOpt = cfg.stages.map(s=>`<option ${t&&t.etapa===s?'selected':''}>${s}</option>`).join('');
      const linkOpt = isLead
        ? Store.data.leads.map(l=>`<option value='${l.id}' ${t&&t.leadId===l.id?'selected':''}>${l.crianca} ‚Äî ${l.responsavel}</option>`).join('')
        : Store.data.entities.map(e=>`<option value='${e.id}' ${t&&t.entityId===e.id?'selected':''}>${e.tipo.toUpperCase()}: ${e.nome}</option>`).join('');
      const addBtn = isLead? '' : `<button id='quickAddEnt' class='ghost'>+ Adicionar pessoa/empresa</button>`;

      openModal((t?'Editar':'Nova')+` tarefa`, `
        <div class='row'>
          <div>
            <label>${isLead? 'Lead vinculado':'Pessoa/Empresa vinculada'}</label>
            <div class='row'>
              <div style='flex:1'><select id='tLink'><option value=''>Selecionar‚Ä¶</option>${linkOpt}</select></div>
              <div style='flex:0'>${addBtn}</div>
            </div>
          </div>
          <div><label>Descri√ß√£o</label><input id='tDesc' value='${t?.descricao||''}'/></div>
        </div>
        <div class='row'>
          <div><label>Prazo</label><input id='tPrazo' type='date' value='${ t? new Date(t.prazo).toISOString().slice(0,10) : ''}'/></div>
          <div>
            <label>Prioridade</label>
            <select id='tPrio'>${['baixa','m√©dia','alta','urgente'].map(p=>`<option ${t&&t.prioridade===p?'selected':''}>${p}</option>`).join('')}</select>
          </div>
          <div>
            <label>Etapa</label>
            <select id='tEtapa'>${stagesOpt}</select>
          </div>
        </div>
        <div class='row'><div class='right'><button id='tSave' class='primary'>Salvar</button></div></div>
      `);

      if(!isLead){
        const btn = $$('#quickAddEnt'); if(btn){ btn.onclick = ()=> openEntityModal(); }
      }

      $$('#tSave').onclick = ()=>{
        const item = t || { id: uid(), tipo:type };
        if(isLead) item.leadId = $$('#tLink').value; else item.entityId = $$('#tLink').value;
        item.descricao = $$('#tDesc').value.trim();
        item.prazo = new Date($$('#tPrazo').value || Date.now()).toISOString();
        item.prioridade = $$('#tPrio').value;
        item.etapa = $$('#tEtapa').value || cfg.stages[0];
        if(!item.descricao){ toast('Descri√ß√£o obrigat√≥ria'); return; }
        if(t){ Object.assign(t,item); } else { cfg.items.push(item); }
        Store.save(); closeModal(); renderTasks();
      }
    }

    /* ==========================
       Pessoas & Empresas
    ========================== */
    $$('#btnNewEnt').addEventListener('click', ()=> openEntityModal());
    $$('#entFilterType').addEventListener('change', renderEntities);
    $$('#entFilterFinalidade').addEventListener('input', renderEntities);

    function renderEntities(){
      const type = $$('#entFilterType').value; const f = $$('#entFilterFinalidade').value.toLowerCase();
      const tbody = $$('#entList'); tbody.innerHTML='';
      Store.data.entities
        .filter(e=> type==='todos' || e.tipo===type)
        .filter(e=> !f || (e.finalidade||'').toLowerCase().includes(f))
        .forEach(e=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${e.tipo}</td><td>${e.nome}</td><td>${e.telefone||'-'}</td><td>${e.finalidade||'-'}</td><td>${e.contatoEmpresa||'-'}</td>`;
          tr.addEventListener('click',()=> openEntityModal(e));
          tbody.appendChild(tr);
        });
    }

        function openEntityModal(ent){
      // Modal para adicionar/editar pessoa/empresa
      openModal(ent ? 'Editar cadastro' : 'Novo cadastro', `
        <div class="row">
          <div>
            <label>Tipo</label>
            <select id="entTipo">
              <option value="pessoa" ${ent?.tipo==="pessoa"?"selected":""}>Pessoa f√≠sica</option>
              <option value="empresa" ${ent?.tipo==="empresa"?"selected":""}>Pessoa jur√≠dica</option>
            </select>
          </div>
        </div>
        <div class="row" id="entFields"></div>
        <div class="row"><div class="right"><button id="entSalvar" class="primary">Salvar</button></div></div>
      `);
      function renderFields(){
        const tipo = $$('#entTipo').value;
        const box = $$('#entFields');
        if(tipo==="pessoa"){
          box.innerHTML = `
            <div><label>Nome</label><input id="entNome" value="${ent?.nome||""}"/></div>
            <div><label>Telefone</label><input id="entTel" value="${ent?.telefone||""}"/></div>
            <div><label>Finalidade do contato</label><input id="entFinalidade" value="${ent?.finalidade||""}" placeholder="Ex: fornecedor, parceria, influenciador"/></div>
          `;
        }else{
          box.innerHTML = `
            <div><label>Nome da empresa</label><input id="entNome" value="${ent?.nome||""}"/></div>
            <div><label>Telefone</label><input id="entTel" value="${ent?.telefone||""}"/></div>
            <div><label>Nome do contato dentro da empresa</label><input id="entContatoEmpresa" value="${ent?.contatoEmpresa||""}"/></div>
            <div><label>Finalidade</label><input id="entFinalidade" value="${ent?.finalidade||""}" placeholder="Ex: conv√™nio, fornecedor"/></div>
          `;
        }
      }
      $$('#entTipo').addEventListener('change', renderFields);
      renderFields();

      $$('#entSalvar').onclick = ()=>{
        const tipo = $$('#entTipo').value;
        const nome = $$('#entNome').value.trim();
        const telefone = $$('#entTel').value.trim();
        const finalidade = $$('#entFinalidade').value.trim();
        let contatoEmpresa = "";
        if(tipo==="empresa") contatoEmpresa = $$('#entContatoEmpresa').value.trim();
        if(!nome){ toast('Preencha o nome'); return; }
        if(ent){
          ent.tipo = tipo;
          ent.nome = nome;
          ent.telefone = telefone;
          ent.finalidade = finalidade;
          ent.contatoEmpresa = contatoEmpresa;
        }else{
          Store.data.entities.push({
            id: uid(),
            tipo,
            nome,
            telefone,
            finalidade,
            contatoEmpresa
          });
        }
        Store.save(); closeModal(); renderEntities();
      }
    }

    // Modal utilit√°rio
    function openModal(title, html){
      $$('#modalTitle').textContent = title;
      $$('#modalBody').innerHTML = html;
      $$('#modal').style.display = 'flex';
    }
    function closeModal(){
      $$('#modal').style.display = 'none';
      $$('#modalBody').innerHTML = '';
    }
    $$('#modalClose').onclick = closeModal;
    window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

    /* ==========================
       DEV: Tema, Layout, Prompt
    ========================== */
    $$('#applyTheme').onclick = ()=>{
      // destaque
      document.body.classList.toggle('accent-grad', $$('#setNeonGrad')?.checked);
      document.documentElement.style.setProperty('--accent-neon', $$('#setNeon').value);
      if($$('#setNeon2')) document.documentElement.style.setProperty('--accent2', $$('#setNeon2').value||'#9cff04');
      // fundo
      document.body.classList.toggle('bg-solid', !$$('#setBgGrad')?.checked);
      document.documentElement.style.setProperty('--bg', $$('#setBg').value);
      if($$('#setBg2')) document.documentElement.style.setProperty('--bg2', $$('#setBg2').value||'#0e1430');
      // fonte geral
      if($$('#setFont').value) document.documentElement.style.setProperty('--font', $$('#setFont').value);
      // menu
      if($$('#setNavBg').value) document.documentElement.style.setProperty('--nav-bg', $$('#setNavBg').value);
      if($$('#setNavText').value) document.documentElement.style.setProperty('--nav-text', $$('#setNavText').value);
      if($$('#setNavFont').value) document.documentElement.style.setProperty('--nav-font', $$('#setNavFont').value);
      // posi√ß√£o do menu
      document.body.dataset.navpos = ($$('#setNavPos')?.value||'left');
      applyNavPosition();
      Store.data.theme = {
        accent: $$('#setNeon').value,
        accent2: $$('#setNeon2')?.value||'#9cff04',
        accentGrad: !!$$('#setNeonGrad')?.checked,
        bg: $$('#setBg').value,
        bg2: $$('#setBg2')?.value||'#0e1430',
        bgGrad: !!$$('#setBgGrad')?.checked,
        font: $$('#setFont').value,
        navBg: $$('#setNavBg')?.value,
        navText: $$('#setNavText')?.value,
        navFont: $$('#setNavFont')?.value,
        navPos: $$('#setNavPos')?.value||'left'
      };
      Store.save();
      toast('Tema aplicado');
    };
    $$('#resetTheme').onclick = ()=>{
      document.documentElement.style.setProperty('--neon', '#c7f603');
      document.documentElement.style.setProperty('--bg', '#0b1020');
      document.documentElement.style.setProperty('--font', 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"');
      $$('#setNeon').value = '#c7f603';
      $$('#setBg').value = '#0b1020';
      $$('#setFont').value = '';
      Store.data.theme = {};
      Store.save();
      toast('Tema restaurado');
    };
    // Carregar tema salvo
    if(Store.data.theme){
      if(Store.data.theme.accent) document.documentElement.style.setProperty('--accent-neon', Store.data.theme.accent);
      if(Store.data.theme.accent2) document.documentElement.style.setProperty('--accent2', Store.data.theme.accent2);
      if(Store.data.theme.accentGrad) document.body.classList.toggle('accent-grad', !!Store.data.theme.accentGrad);
      if(Store.data.theme.bg) document.documentElement.style.setProperty('--bg', Store.data.theme.bg);
      if(Store.data.theme.bg2) document.documentElement.style.setProperty('--bg2', Store.data.theme.bg2);
      if(Store.data.theme.bgGrad===false) document.body.classList.add('bg-solid');
      if(Store.data.theme.font) document.documentElement.style.setProperty('--font', Store.data.theme.font);
      if(Store.data.theme.navBg) document.documentElement.style.setProperty('--nav-bg', Store.data.theme.navBg);
      if(Store.data.theme.navText) document.documentElement.style.setProperty('--nav-text', Store.data.theme.navText);
      if(Store.data.theme.navFont) document.documentElement.style.setProperty('--nav-font', Store.data.theme.navFont);
      if(Store.data.theme.navPos) { document.body.dataset.navpos=Store.data.theme.navPos; applyNavPosition(); }
      if($$('#setNeon')) $$('#setNeon').value = Store.data.theme.accent||'#c7f603';
      if($$('#setNeon2')) $$('#setNeon2').value = Store.data.theme.accent2||'#9cff04';
      if($$('#setNeonGrad')) $$('#setNeonGrad').checked = !!Store.data.theme.accentGrad;
      if($$('#setBg')) $$('#setBg').value = Store.data.theme.bg||'#0b1020';
      if($$('#setBg2')) $$('#setBg2').value = Store.data.theme.bg2||'#0e1430';
      if($$('#setBgGrad')) $$('#setBgGrad').checked = !!Store.data.theme.bgGrad;
      if($$('#setFont')) $$('#setFont').value = Store.data.theme.font||'';
      if($$('#setNavBg')) $$('#setNavBg').value = Store.data.theme.navBg||'';
      if($$('#setNavText')) $$('#setNavText').value = Store.data.theme.navText||'';
      if($$('#setNavFont')) $$('#setNavFont').value = Store.data.theme.navFont||'';
      if($$('#setNavPos')) $$('#setNavPos').value = Store.data.theme.navPos||'left';
    }

    function applyNavPosition(){
      const layout = document.querySelector('.layout'); const nav = document.querySelector('nav'); const main = document.querySelector('main');
      if(document.body.dataset.navpos==='top'){
        layout.style.flexDirection='column'; nav.style.width='100%'; nav.style.borderRight='none'; nav.style.borderBottom='1px solid var(--muted)';
      }else{
        layout.style.flexDirection='row'; nav.style.width='260px'; nav.style.borderBottom='none'; nav.style.borderRight='1px solid var(--muted)';
      }
    }

    // DEV: prompts para LLM
    $$('#genTabPrompt').onclick = ()=>{
      $$('#tabPrompt').value =
`Contexto: Neon Educacional CRM, single HTML.
Quero adicionar uma nova aba ao CRM.
Explique o objetivo da aba, onde ser√° inserida no c√≥digo, obrigatoriedades e peculiaridades.
Exemplo de prompt:
"Quero uma aba chamada 'Financeiro' para controlar pagamentos dos alunos. Ela deve aparecer no menu lateral, ter cards de recebimentos, filtros por per√≠odo, e op√ß√£o de exportar dados. Precisa ser responsiva e usar o mesmo padr√£o visual das outras abas."`;
    };
    $$('#copyTabPrompt').onclick = ()=>{ $$('#tabPrompt').select(); document.execCommand('copy'); toast('Prompt copiado!'); };
    $$('#genFeatPrompt').onclick = ()=>{
      $$('#featPrompt').value =
`Contexto: Neon Educacional CRM, single HTML.
Quero adicionar uma nova funcionalidade ao CRM.
Explique o objetivo, onde ser√° inserida, obrigatoriedades e peculiaridades.
Exemplo de prompt:
"Quero uma funcionalidade de envio de WhatsApp para leads. Bot√£o em cada card de lead, que abre link do WhatsApp com mensagem personalizada. Precisa funcionar em desktop e mobile."`;
    };
    $$('#copyFeatPrompt').onclick = ()=>{ $$('#featPrompt').select(); document.execCommand('copy'); toast('Prompt copiado!'); };

    $$('#addBlankTab').onclick = ()=>{
      const name = prompt('Nome da nova aba:');
      if(!name) return;
      // Adiciona bot√£o no menu lateral
      const nav = document.querySelector('nav');
      const btn = document.createElement('button');
      btn.className = 'tab';
      btn.dataset.tab = name.toLowerCase().replace(/\s+/g,'');
      btn.textContent = `üÜï ${name}`;
      nav.appendChild(btn);
      // Adiciona section vazia
      const main = document.querySelector('main');
      const sec = document.createElement('section');
      sec.id = btn.dataset.tab;
      sec.className = 'tabview hidden';
      sec.innerHTML = `<div class="card"><h3>${name}</h3><div>Conte√∫do inicial da aba "${name}".</div></div>`;
      main.appendChild(sec);
      btn.onclick = ()=> {
        $$$('nav .tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $$$('.tabview').forEach(s=>s.classList.add('hidden'));
        sec.classList.remove('hidden');
      };
      toast('Nova aba adicionada!');
    };

    /* ==========================
       Backup: Exportar/Importar
    ========================== */
    $$('#btnExport').onclick = ()=>{
      const data = JSON.stringify(Store.data, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'neon-crm-backup.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
      toast('Backup exportado!');
    };
    $$('#fileImport').onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const data = JSON.parse(ev.target.result);
          // Valida√ß√£o b√°sica dos dados
          if(Array.isArray(data.leads) && typeof data.tasks === 'object' && Array.isArray(data.entities)){
            // Atualiza Store.data corretamente
            Store.data.stages = Array.isArray(data.stages) ? data.stages : Store.data.stages;
            Store.data.leads = data.leads;
            Store.data.tasks = data.tasks;
            Store.data.entities = data.entities;
            Store.data.theme = data.theme || {};
            Store.save();
            toast('Backup importado!');
            // Atualiza todas as abas
            refreshEtapasOptions();
            renderLeads();
            renderTasks();
            renderEntities();
            calcKPIs();
          }else{
            toast('Arquivo inv√°lido');
          }
        }catch(err){
          toast('Erro ao importar');
        }
      };
      reader.readAsText(file);
    };
    $$('#btnImport').onclick = () => {
      const fileInput = $$('#fileImport');
      if (!fileInput.files.length) {
        toast('Selecione um arquivo .json para importar');
        return;
      }
      // Dispara o evento onchange manualmente para garantir execu√ß√£o
      const event = new Event('change');
      fileInput.dispatchEvent(event);
    };

    // Inicializa√ß√£o
    renderLeads();
    renderTasks();
    renderEntities();
    calcKPIs();
  </script>
</body>
</html>